#!/usr/bin/env python3
"""
ì œì™¸ ì˜ì—­ ê²¹ì¹¨ ê²€ì‚¬ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
========================================

ì‹¤ì œ ì½”ë“œë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ì—¬ ëª¨ë“  ì¼€ì´ìŠ¤ê°€ ì •í™•íˆ ë™ì‘í•˜ëŠ”ì§€ ê²€ì¦
"""

import sys

# ì‹¤ì œ ì½”ë“œì—ì„œ ì‚¬ìš©í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ ë³µì‚¬
def _point_in_polygon(point, polygon):
    """ì ì´ í´ë¦¬ê³¤ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸ (Ray casting algorithm)"""
    x, y = point
    n = len(polygon)
    inside = False

    p1x, p1y = polygon[0]
    for i in range(1, n + 1):
        p2x, p2y = polygon[i % n]
        if y > min(p1y, p2y):
            if y <= max(p1y, p2y):
                if x <= max(p1x, p2x):
                    if p1y != p2y:
                        xinters = (y - p1y) * (p2x - p1x) / (p2y - p1y) + p1x
                    if p1x == p2x or x <= xinters:
                        inside = not inside
        p1x, p1y = p2x, p2y

    return inside

def _segments_intersect(p1, p2, p3, p4):
    """ë‘ ì„ ë¶„ì´ êµì°¨í•˜ëŠ”ì§€ í™•ì¸"""
    def ccw(A, B, C):
        return (C[1] - A[1]) * (B[0] - A[0]) > (B[1] - A[1]) * (C[0] - A[0])

    return ccw(p1, p3, p4) != ccw(p2, p3, p4) and ccw(p1, p2, p3) != ccw(p1, p2, p4)

def _bbox_polygon_overlap(x1, y1, x2, y2, polygon):
    """bboxì™€ í´ë¦¬ê³¤ì´ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸ (ë©´ì  ê¸°ë°˜)"""
    # bbox ì¢Œí‘œ ì •ê·œí™” (x1 < x2, y1 < y2 ë³´ì¥)
    min_x, max_x = min(x1, x2), max(x1, x2)
    min_y, max_y = min(y1, y2), max(y1, y2)

    # 1. bboxì˜ ë„¤ ëª¨ì„œë¦¬ ì¤‘ í•˜ë‚˜ë¼ë„ í´ë¦¬ê³¤ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸
    bbox_corners = [
        (min_x, min_y),  # ì™¼ìª½ ìœ„
        (max_x, min_y),  # ì˜¤ë¥¸ìª½ ìœ„
        (min_x, max_y),  # ì™¼ìª½ ì•„ë˜
        (max_x, max_y)   # ì˜¤ë¥¸ìª½ ì•„ë˜
    ]

    for corner in bbox_corners:
        if _point_in_polygon(corner, polygon):
            print(f"    âœ“ ê²€ì‚¬1 í†µê³¼: bbox ëª¨ì„œë¦¬ {corner}ê°€ í´ë¦¬ê³¤ ì•ˆì— ìˆìŒ")
            return True

    # 2. í´ë¦¬ê³¤ì˜ ì  ì¤‘ í•˜ë‚˜ë¼ë„ bbox ì•ˆì— ìˆëŠ”ì§€ í™•ì¸
    for point in polygon:
        px, py = point
        if min_x <= px <= max_x and min_y <= py <= max_y:
            print(f"    âœ“ ê²€ì‚¬2 í†µê³¼: í´ë¦¬ê³¤ ì  {point}ê°€ bbox [{min_x},{min_y},{max_x},{max_y}] ì•ˆì— ìˆìŒ")
            return True

    # 3. bboxì˜ ë³€ê³¼ í´ë¦¬ê³¤ì˜ ë³€ì´ êµì°¨í•˜ëŠ”ì§€ í™•ì¸
    bbox_edges = [
        ((min_x, min_y), (max_x, min_y)),  # ìœ„ìª½ ë³€
        ((max_x, min_y), (max_x, max_y)),  # ì˜¤ë¥¸ìª½ ë³€
        ((max_x, max_y), (min_x, max_y)),  # ì•„ë˜ìª½ ë³€
        ((min_x, max_y), (min_x, min_y))   # ì™¼ìª½ ë³€
    ]

    n = len(polygon)
    for i in range(n):
        polygon_edge = (polygon[i], polygon[(i + 1) % n])
        for bbox_edge in bbox_edges:
            if _segments_intersect(bbox_edge[0], bbox_edge[1], polygon_edge[0], polygon_edge[1]):
                print(f"    âœ“ ê²€ì‚¬3 í†µê³¼: bbox ë³€ê³¼ í´ë¦¬ê³¤ ë³€ì´ êµì°¨")
                return True  # ë³€ë“¤ì´ êµì°¨í•¨

    return False  # ê²¹ì¹˜ì§€ ì•ŠìŒ


print("=" * 80)
print("ì œì™¸ ì˜ì—­ ê²¹ì¹¨ ê²€ì‚¬ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸")
print("=" * 80)
print()

# í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë“¤
test_cases = []

# ============================================================================
# ì¼€ì´ìŠ¤ 1: ì‘ì€ ì œì™¸ì˜ì—­ì´ í° ë¼ë²¨ì— ì™„ì „íˆ í¬í•¨ë¨ (ì‚¬ìš©ì ìš”ì²­ ì¼€ì´ìŠ¤)
# ============================================================================
test_cases.append({
    "name": "ì¼€ì´ìŠ¤ 1: ì‘ì€ ì œì™¸ì˜ì—­ + í° ë¼ë²¨ (ì™„ì „ í¬í•¨)",
    "bbox": (50, 50, 250, 250),  # í° bbox
    "polygon": [(100, 100), (150, 100), (150, 150), (100, 150)],  # ì‘ì€ ì‚¬ê°í˜• ì œì™¸ì˜ì—­
    "expected": True,
    "description": "ì œì™¸ì˜ì—­ì´ ì‘ê³  ë¼ë²¨ì´ ë®ê³  ìˆìŒ - í´ë¦¬ê³¤ ì ë“¤ì´ bbox ì•ˆì— ìˆìŒ"
})

# ============================================================================
# ì¼€ì´ìŠ¤ 2: í° ì œì™¸ì˜ì—­ì— ì‘ì€ ë¼ë²¨ì´ ì™„ì „íˆ í¬í•¨ë¨
# ============================================================================
test_cases.append({
    "name": "ì¼€ì´ìŠ¤ 2: í° ì œì™¸ì˜ì—­ + ì‘ì€ ë¼ë²¨ (ë¼ë²¨ í¬í•¨)",
    "bbox": (100, 100, 150, 150),  # ì‘ì€ bbox
    "polygon": [(50, 50), (250, 50), (250, 250), (50, 250)],  # í° ì‚¬ê°í˜• ì œì™¸ì˜ì—­
    "expected": True,
    "description": "ë¼ë²¨ì´ ì œì™¸ì˜ì—­ ì•ˆì— ì™„ì „íˆ í¬í•¨ë¨ - bbox ëª¨ì„œë¦¬ê°€ í´ë¦¬ê³¤ ì•ˆì— ìˆìŒ"
})

# ============================================================================
# ì¼€ì´ìŠ¤ 3: ë¼ë²¨ì´ ì œì™¸ì˜ì—­ ê²½ê³„ë¥¼ ê±¸ì¹¨ (ì¼ë¶€ ê²¹ì¹¨)
# ============================================================================
test_cases.append({
    "name": "ì¼€ì´ìŠ¤ 3: ë¼ë²¨ì´ ì œì™¸ì˜ì—­ ê²½ê³„ ê±¸ì¹¨",
    "bbox": (120, 120, 180, 180),  # bbox
    "polygon": [(100, 100), (150, 100), (150, 150), (100, 150)],  # ì œì™¸ì˜ì—­
    "expected": True,
    "description": "bboxê°€ ì œì™¸ì˜ì—­ ê²½ê³„ë¥¼ ê±¸ì¹¨ - bbox ëª¨ì„œë¦¬ê°€ í´ë¦¬ê³¤ ì•ˆ ë˜ëŠ” ë³€ êµì°¨"
})

# ============================================================================
# ì¼€ì´ìŠ¤ 4: ë¼ë²¨ê³¼ ì œì™¸ì˜ì—­ì´ ì™„ì „íˆ ë–¨ì–´ì§
# ============================================================================
test_cases.append({
    "name": "ì¼€ì´ìŠ¤ 4: ë¼ë²¨ê³¼ ì œì™¸ì˜ì—­ ì™„ì „íˆ ë–¨ì–´ì§",
    "bbox": (200, 200, 250, 250),  # bbox
    "polygon": [(50, 50), (100, 50), (100, 100), (50, 100)],  # ì œì™¸ì˜ì—­
    "expected": False,
    "description": "bboxì™€ ì œì™¸ì˜ì—­ì´ ì „í˜€ ê²¹ì¹˜ì§€ ì•ŠìŒ"
})

# ============================================================================
# ì¼€ì´ìŠ¤ 5: ì˜¤ë¥¸ìª½â†’ì™¼ìª½ìœ¼ë¡œ ê·¸ë¦° bbox + ì‘ì€ ì œì™¸ì˜ì—­
# ============================================================================
test_cases.append({
    "name": "ì¼€ì´ìŠ¤ 5: ì—­ë°©í–¥ bbox (ì˜¤ë¥¸ìª½â†’ì™¼ìª½) + ì‘ì€ ì œì™¸ì˜ì—­",
    "bbox": (250, 50, 50, 250),  # ì—­ë°©í–¥ bbox (x1 > x2)
    "polygon": [(100, 100), (150, 100), (150, 150), (100, 150)],  # ì‘ì€ ì œì™¸ì˜ì—­
    "expected": True,
    "description": "ì—­ë°©í–¥ bboxì—ì„œë„ ì •ê·œí™”ë¡œ ì •í™•íˆ ê°ì§€"
})

# ============================================================================
# ì¼€ì´ìŠ¤ 6: ì•„ë˜â†’ìœ„ë¡œ ê·¸ë¦° bbox + ì‘ì€ ì œì™¸ì˜ì—­
# ============================================================================
test_cases.append({
    "name": "ì¼€ì´ìŠ¤ 6: ì—­ë°©í–¥ bbox (ì•„ë˜â†’ìœ„) + ì‘ì€ ì œì™¸ì˜ì—­",
    "bbox": (50, 250, 250, 50),  # ì—­ë°©í–¥ bbox (y1 > y2)
    "polygon": [(100, 100), (150, 100), (150, 150), (100, 150)],  # ì‘ì€ ì œì™¸ì˜ì—­
    "expected": True,
    "description": "ì—­ë°©í–¥ bboxì—ì„œë„ ì •ê·œí™”ë¡œ ì •í™•íˆ ê°ì§€"
})

# ============================================================================
# ì¼€ì´ìŠ¤ 7: ë§¤ìš° ì‘ì€ ì œì™¸ì˜ì—­ (ì ì— ê°€ê¹Œì›€) + í° ë¼ë²¨
# ============================================================================
test_cases.append({
    "name": "ì¼€ì´ìŠ¤ 7: ë§¤ìš° ì‘ì€ ì œì™¸ì˜ì—­ + í° ë¼ë²¨",
    "bbox": (50, 50, 250, 250),  # í° bbox
    "polygon": [(120, 120), (125, 120), (125, 125), (120, 125)],  # ë§¤ìš° ì‘ì€ ì œì™¸ì˜ì—­
    "expected": True,
    "description": "ë§¤ìš° ì‘ì€ ì œì™¸ì˜ì—­ë„ ì •í™•íˆ ê°ì§€"
})

# ============================================================================
# ì¼€ì´ìŠ¤ 8: ë³µì¡í•œ í´ë¦¬ê³¤ ì œì™¸ì˜ì—­
# ============================================================================
test_cases.append({
    "name": "ì¼€ì´ìŠ¤ 8: ë³µì¡í•œ í´ë¦¬ê³¤ ì œì™¸ì˜ì—­ + ë¼ë²¨ ê²¹ì¹¨",
    "bbox": (100, 100, 200, 200),  # bbox
    "polygon": [(120, 80), (180, 120), (150, 180), (90, 140)],  # ë³µì¡í•œ í´ë¦¬ê³¤
    "expected": True,
    "description": "ë³µì¡í•œ í´ë¦¬ê³¤ í˜•íƒœë„ ì •í™•íˆ ê°ì§€"
})

# ============================================================================
# ì¼€ì´ìŠ¤ 9: Lì í˜•íƒœ í´ë¦¬ê³¤ + ë¼ë²¨ì´ í•œìª½ì—ë§Œ ê²¹ì¹¨
# ============================================================================
test_cases.append({
    "name": "ì¼€ì´ìŠ¤ 9: Lì í´ë¦¬ê³¤ + ë¶€ë¶„ ê²¹ì¹¨",
    "bbox": (70, 70, 95, 95),  # Lìì˜ ì™¼ìª½ ìœ„ ë¶€ë¶„ê³¼ ê²¹ì¹˜ë„ë¡ ì¡°ì •
    "polygon": [(50, 50), (150, 50), (150, 80), (80, 80), (80, 150), (50, 150)],  # Lì
    "expected": True,
    "description": "Lì í˜•íƒœ í´ë¦¬ê³¤ê³¼ì˜ ê²¹ì¹¨ ê°ì§€"
})

# ============================================================================
# ì¼€ì´ìŠ¤ 10: ë§¤ìš° ê°€ëŠë‹¤ë€ ì œì™¸ì˜ì—­ (ì„ ì— ê°€ê¹Œì›€)
# ============================================================================
test_cases.append({
    "name": "ì¼€ì´ìŠ¤ 10: ê°€ëŠë‹¤ë€ ì œì™¸ì˜ì—­ + ë¼ë²¨ êµì°¨",
    "bbox": (50, 90, 150, 110),  # ê°€ë¡œë¡œ ê¸´ bbox
    "polygon": [(95, 50), (105, 50), (105, 150), (95, 150)],  # ì„¸ë¡œë¡œ ê¸´ ì œì™¸ì˜ì—­
    "expected": True,
    "description": "ê°€ëŠë‹¤ë€ ì œì™¸ì˜ì—­ê³¼ì˜ êµì°¨ ê°ì§€"
})

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
print("ì´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤:", len(test_cases))
print()

passed = 0
failed = 0
failed_cases = []

for i, test in enumerate(test_cases, 1):
    print(f"[í…ŒìŠ¤íŠ¸ {i}/{len(test_cases)}] {test['name']}")
    print(f"  ì„¤ëª…: {test['description']}")
    print(f"  bbox: {test['bbox']}")
    print(f"  polygon: {test['polygon'][:3]}{'...' if len(test['polygon']) > 3 else ''}")
    print(f"  ì˜ˆìƒ ê²°ê³¼: {'ê²¹ì¹¨(True)' if test['expected'] else 'ì•ˆ ê²¹ì¹¨(False)'}")

    result = _bbox_polygon_overlap(
        test['bbox'][0], test['bbox'][1],
        test['bbox'][2], test['bbox'][3],
        test['polygon']
    )

    if result == test['expected']:
        print(f"  âœ… í†µê³¼: {result}")
        passed += 1
    else:
        print(f"  âŒ ì‹¤íŒ¨: ì˜ˆìƒ {test['expected']}, ì‹¤ì œ {result}")
        failed += 1
        failed_cases.append(f"ì¼€ì´ìŠ¤ {i}: {test['name']}")
    print()

print("=" * 80)
print("í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½")
print("=" * 80)
print()
print(f"ì´ í…ŒìŠ¤íŠ¸: {len(test_cases)}")
print(f"âœ… í†µê³¼: {passed}")
print(f"âŒ ì‹¤íŒ¨: {failed}")
print()

if failed > 0:
    print("ì‹¤íŒ¨í•œ ì¼€ì´ìŠ¤:")
    for case in failed_cases:
        print(f"  - {case}")
    print()
    sys.exit(1)
else:
    print("ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!")
    print()
    print("ê²€ì¦ ì™„ë£Œ:")
    print("  âœ“ ì‘ì€ ì œì™¸ì˜ì—­ + í° ë¼ë²¨ (ì™„ì „ í¬í•¨) - ì •ìƒ ë™ì‘")
    print("  âœ“ í° ì œì™¸ì˜ì—­ + ì‘ì€ ë¼ë²¨ (ë¼ë²¨ í¬í•¨) - ì •ìƒ ë™ì‘")
    print("  âœ“ ë¶€ë¶„ ê²¹ì¹¨ - ì •ìƒ ë™ì‘")
    print("  âœ“ ì™„ì „íˆ ë–¨ì–´ì§ - ì •ìƒ ë™ì‘")
    print("  âœ“ ì—­ë°©í–¥ bbox - ì •ìƒ ë™ì‘")
    print("  âœ“ ë³µì¡í•œ í´ë¦¬ê³¤ - ì •ìƒ ë™ì‘")
    print()
    sys.exit(0)
